[{"id":"3d0770ee.9fd28","type":"tab","label":"Flow 1","disabled":false,"info":""},{"id":"18ecc450.cecb0c","type":"server","z":"","name":"Home Assistant","url":"http://192.168.0.111:8123","pass":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiI2MGU1ODAyNGY2ZDk0MjdkOTcyYzc2MDYzMDhiYTM4ZCIsImlhdCI6MTU0NzM1MzQ1NywiZXhwIjoxODYyNzEzNDU3fQ.1iha9EDa2uJfTgw2KXeZYKd4s4CUG2JMRbA1YYtl8HI"},{"id":"2765943d.d5b22c","type":"hue-bridge","z":"","name":"Philips hue","bridge":"192.168.0.203","key":"UQAU1ynmZgC9o2UdPVvlo-GbqQ9MvVmSOeX1ysZ9","interval":"8000"},{"id":"e14ddd74.e008f","type":"mqtt-broker","z":"","name":"ddd","broker":"localhost","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"d92d7fb2.e096","type":"api-call-service","z":"3d0770ee.9fd28","name":"Kitchen Lights On","server":"18ecc450.cecb0c","service_domain":"light","service":"turn_on","data":"{ \"entity_id\": \"light.kitchen\",  \"brightness\": \"255\" }","mergecontext":"","x":990,"y":80,"wires":[[]]},{"id":"3cb9214f.ee15fe","type":"api-call-service","z":"3d0770ee.9fd28","name":"Turn on Bedroom Lights","server":"18ecc450.cecb0c","service_domain":"light","service":"turn_on","data":"{ \"entity_id\": \"light.bedroom\",  \"brightness\": \"255\", \"color_name\": \"white\"}","mergecontext":"","x":1090,"y":260,"wires":[[]]},{"id":"754fa58e.7860ec","type":"api-call-service","z":"3d0770ee.9fd28","name":"Turn off Bedroom Lights","server":"18ecc450.cecb0c","service_domain":"light","service":"turn_off","data":"{ \"entity_id\": \"light.bedroom\", \"transition\": \"5\" }","mergecontext":"","x":1250,"y":360,"wires":[[]]},{"id":"841648e6.f6ff08","type":"api-call-service","z":"3d0770ee.9fd28","name":"Kitchen Lights Off","server":"18ecc450.cecb0c","service_domain":"light","service":"turn_off","data":"{ \"entity_id\": \"light.kitchen\" , \"transition\": \"5\"}","mergecontext":"","x":730,"y":160,"wires":[[]]},{"id":"fbed19fb.f048e8","type":"stoptimer","z":"3d0770ee.9fd28","duration":"2","units":"Minute","payloadtype":"num","payloadval":"0","name":"","x":780,"y":360,"wires":[["6d99b08f.3a1bd"],[]]},{"id":"58c92e93.94512","type":"stoptimer","z":"3d0770ee.9fd28","duration":"1","units":"Minute","payloadtype":"num","payloadval":"0","name":"","x":520,"y":160,"wires":[["841648e6.f6ff08"],[]]},{"id":"fa347ae8.6ce478","type":"hue-switch","z":"3d0770ee.9fd28","name":"Kitchen switch","bridge":"2765943d.d5b22c","sensorid":"6","x":100,"y":620,"wires":[[]]},{"id":"4e0b40af.e246d","type":"switch","z":"3d0770ee.9fd28","name":"On Button","property":"payload.name","propertyType":"msg","rules":[{"t":"eq","v":"On","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":310,"y":540,"wires":[["327d777.d94a788","d7193e5b.8fdd"]]},{"id":"327d777.d94a788","type":"switch","z":"3d0770ee.9fd28","name":"Press Type","property":"payload.action","propertyType":"msg","rules":[{"t":"eq","v":"short released","vt":"str"},{"t":"eq","v":"long released","vt":"str"},{"t":"eq","v":"holded","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":490,"y":540,"wires":[["ec9b1cdc.0ed51"],["e19298c8.add3c8"],["58c9c6db.cdf258"]]},{"id":"58c9c6db.cdf258","type":"api-call-service","z":"3d0770ee.9fd28","name":"Lamp On","server":"18ecc450.cecb0c","service_domain":"switch","service":"turn_on","data":"{ \"entity_id\": \"switch.living_room_lamp\"}","mergecontext":"","x":1440,"y":560,"wires":[[]]},{"id":"848207d8.d970f8","type":"switch","z":"3d0770ee.9fd28","name":"Off Button","property":"payload.name","propertyType":"msg","rules":[{"t":"eq","v":"Off","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":310,"y":620,"wires":[["564f560c.5e5388","6d4fd839.d33528"]]},{"id":"564f560c.5e5388","type":"switch","z":"3d0770ee.9fd28","name":"Press Type","property":"payload.action","propertyType":"msg","rules":[{"t":"eq","v":"short released","vt":"str"},{"t":"eq","v":"long released","vt":"str"},{"t":"eq","v":"holded","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":490,"y":620,"wires":[["37ad8768.3ae198"],[],["3d32bc95.2b1c04"]]},{"id":"e4c500fc.8a05e","type":"switch","z":"3d0770ee.9fd28","name":"Press Type","property":"payload.action","propertyType":"msg","rules":[{"t":"eq","v":"short released","vt":"str"},{"t":"eq","v":"long released","vt":"str"},{"t":"eq","v":"holded","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":490,"y":700,"wires":[["b359a41a.d9de58"],[],["10ea7f53.970af1"]]},{"id":"560a6b6a.fdc2d4","type":"switch","z":"3d0770ee.9fd28","name":"Press Type","property":"payload.action","propertyType":"msg","rules":[{"t":"eq","v":"short released","vt":"str"},{"t":"eq","v":"long released","vt":"str"},{"t":"eq","v":"holded","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":490,"y":780,"wires":[["decafa41.13d9d8"],[],["44741af3.219094"]]},{"id":"73f69328.74014c","type":"function","z":"3d0770ee.9fd28","name":"Incr CT 25%","func":"function newCT(current_CT) {\n    newCTPct = (current_CT / 512 + 0.25) * 512\n    return Math.max(0, Math.min(512, Math.round(newCTPct)))\n}\n\nnewMsg = {\n    payload: {\n        \"data\": {\n            \"entity_id\": \"light.kitchen\",\n            \"color_temp\": newCT(msg.payload.ct)\n    \n        }    \n    }\n}\nreturn newMsg;","outputs":1,"noerr":0,"x":850,"y":720,"wires":[["2c0bf2b9.275fae"]]},{"id":"2c0bf2b9.275fae","type":"api-call-service","z":"3d0770ee.9fd28","name":"Adjust Kitchen Lights","server":"18ecc450.cecb0c","service_domain":"light","service":"turn_on","data":"{}","mergecontext":"","x":1120,"y":760,"wires":[[]]},{"id":"37ad8768.3ae198","type":"api-call-service","z":"3d0770ee.9fd28","name":"Kitchen Lights Off","server":"18ecc450.cecb0c","service_domain":"light","service":"turn_off","data":"{ \"entity_id\": \"light.kitchen\" , \"transition\": \"0.5\"}","mergecontext":"","x":650,"y":580,"wires":[[]]},{"id":"3d32bc95.2b1c04","type":"api-call-service","z":"3d0770ee.9fd28","name":"Lamp Off","server":"18ecc450.cecb0c","service_domain":"switch","service":"turn_off","data":"{ \"entity_id\": \"switch.living_room_lamp\"}","mergecontext":"","x":1500,"y":680,"wires":[[]]},{"id":"10ea7f53.970af1","type":"Hue Pull","z":"3d0770ee.9fd28","deviceid":"g-2","serverid":"001788fffe4db78d","name":"","x":720,"y":840,"wires":[["73f69328.74014c"],[]]},{"id":"ec9b1cdc.0ed51","type":"api-call-service","z":"3d0770ee.9fd28","name":"Kitchen Lights On","server":"18ecc450.cecb0c","service_domain":"light","service":"turn_on","data":"{ \"entity_id\": \"light.kitchen\"}","mergecontext":"","x":690,"y":520,"wires":[[]]},{"id":"c838fed0.38f9d","type":"function","z":"3d0770ee.9fd28","name":"Decr Bri 25%","func":"function newBrightness(current_brightness) {\n    newBrightnessPct = (current_brightness / 256 - 0.25) * 100\n    return Math.max(0, Math.min(100, Math.round(newBrightnessPct)))\n}\n\nnewMsg = {\n    payload: {\n        \"data\": {\n            \"entity_id\": \"light.kitchen\",\n            \"brightness_pct\": newBrightness(msg.payload.bri)\n    \n        }    \n    }\n}\nreturn newMsg;","outputs":1,"noerr":0,"x":860,"y":760,"wires":[[]]},{"id":"decafa41.13d9d8","type":"Hue Pull","z":"3d0770ee.9fd28","deviceid":"g-2","serverid":"001788fffe4db78d","name":"","x":680,"y":760,"wires":[["c838fed0.38f9d"],[]]},{"id":"a0f99412.9a0b98","type":"function","z":"3d0770ee.9fd28","name":"Decr CT 25%","func":"function newCT(current_CT) {\n    newCTPct = (current_CT / 512 - 0.25) * 512\n    return Math.max(0, Math.min(512, Math.round(newCTPct)))\n}\n\nnewMsg = {\n    payload: {\n        \"data\": {\n            \"entity_id\": \"light.kitchen\",\n            \"color_temp\": newCT(msg.payload.ct)\n    \n        }    \n    }\n}\nreturn newMsg;","outputs":1,"noerr":0,"x":860,"y":800,"wires":[["2c0bf2b9.275fae"]]},{"id":"44741af3.219094","type":"Hue Pull","z":"3d0770ee.9fd28","deviceid":"g-2","serverid":"001788fffe4db78d","name":"","x":680,"y":800,"wires":[["a0f99412.9a0b98"],[]]},{"id":"b359a41a.d9de58","type":"Hue Pull","z":"3d0770ee.9fd28","deviceid":"g-2","serverid":"001788fffe4db78d","name":"","x":680,"y":680,"wires":[["c8dbf8a.8f2be08"],[]]},{"id":"28d74156.b7e9ae","type":"switch","z":"3d0770ee.9fd28","name":"Brighten Button","property":"payload.name","propertyType":"msg","rules":[{"t":"eq","v":"Dim Up","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":320,"y":700,"wires":[["e4c500fc.8a05e"]]},{"id":"2921290c.814bf6","type":"switch","z":"3d0770ee.9fd28","name":"Dim Button","property":"payload.name","propertyType":"msg","rules":[{"t":"eq","v":"Dim Down","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":310,"y":780,"wires":[["560a6b6a.fdc2d4"]]},{"id":"c8dbf8a.8f2be08","type":"function","z":"3d0770ee.9fd28","name":"Incr Bri 25%","func":"function newBrightness(current_brightness) {\n    newBrightnessPct = (current_brightness / 256 + 0.25) * 100\n    return Math.max(0, Math.min(100, Math.round(newBrightnessPct)))\n}\n\nnewMsg = {\n    payload: {\n        \"data\": {\n            \"entity_id\": \"light.kitchen\",\n            \"brightness_pct\": newBrightness(msg.payload.bri)\n    \n        }    \n    }\n}\nreturn newMsg;","outputs":1,"noerr":0,"x":850,"y":680,"wires":[["2c0bf2b9.275fae"]]},{"id":"e19298c8.add3c8","type":"api-call-service","z":"3d0770ee.9fd28","name":"Kitchen Lights On","server":"18ecc450.cecb0c","service_domain":"light","service":"turn_on","data":"{ \"entity_id\": \"light.kitchen\", \"brightness_pct\": \"100\" }","mergecontext":"","x":930,"y":540,"wires":[[]]},{"id":"d7193e5b.8fdd","type":"looptimer","z":"3d0770ee.9fd28","duration":"30","units":"Second","maxloops":"100","maxtimeout":"15","maxtimeoutunits":"Minute","name":"Keep lights on 15 min","x":400,"y":480,"wires":[["58c92e93.94512"],[]]},{"id":"8cee1e78.e4952","type":"api-current-state","z":"3d0770ee.9fd28","name":"Bed Status","server":"18ecc450.cecb0c","halt_if":"","override_topic":true,"override_payload":true,"entity_id":"sensor.bed_occupied","x":470,"y":60,"wires":[["533ccc38.669dc4"]]},{"id":"533ccc38.669dc4","type":"switch","z":"3d0770ee.9fd28","name":"In Bed?","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":620,"y":60,"wires":[["d94057cd.ed3f58"],["d92d7fb2.e096"]]},{"id":"25a696ba.8f010a","type":"api-call-service","z":"3d0770ee.9fd28","name":"Kitchen Lights Dim","server":"18ecc450.cecb0c","service_domain":"light","service":"turn_on","data":"{ \"entity_id\": \"light.kitchen\",  \"brightness\": \"25\", \"color_temp\": \"512\" }","mergecontext":"","x":990,"y":40,"wires":[[]]},{"id":"6d4fd839.d33528","type":"change","z":"3d0770ee.9fd28","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"STOP","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":150,"y":480,"wires":[["d7193e5b.8fdd"]]},{"id":"20dded2b.05a4c2","type":"change","z":"3d0770ee.9fd28","name":"STOP","rules":[{"t":"set","p":"payload","pt":"msg","to":"STOP","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":490,"y":100,"wires":[["58c92e93.94512"]]},{"id":"cb9b659b.08da48","type":"change","z":"3d0770ee.9fd28","name":"STOP","rules":[{"t":"set","p":"payload","pt":"msg","to":"STOP","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":650,"y":300,"wires":[["fbed19fb.f048e8"]]},{"id":"d94057cd.ed3f58","type":"time-range-switch","z":"3d0770ee.9fd28","name":"","lat":"","lon":"","startTime":"06:15","endTime":"20:00","startOffset":0,"endOffset":0,"x":780,"y":20,"wires":[["d92d7fb2.e096"],["25a696ba.8f010a"]]},{"id":"88b55d54.f4ef","type":"mqtt in","z":"3d0770ee.9fd28","name":"","topic":"hue/kitchen_switch/buttonevent","qos":"2","broker":"e14ddd74.e008f","x":130,"y":1100,"wires":[["8fbe4268.72746","46e7329e.b1126c"]]},{"id":"cd741398.4deb9","type":"function","z":"3d0770ee.9fd28","name":"Decr Bri 25%","func":"function newBrightness(current_brightness) {\n    newBrightnessPct = (current_brightness / 256 - 0.25) * 100\n    return Math.max(0, Math.min(100, Math.round(newBrightnessPct)))\n}\n\nnewMsg = {\n    payload: {\n        \"data\": {\n            \"entity_id\": \"light.kitchen\",\n            \"brightness_pct\": newBrightness(msg.payload.bri)\n    \n        }    \n    }\n}\nreturn newMsg;","outputs":1,"noerr":0,"x":780,"y":880,"wires":[["2c0bf2b9.275fae"]]},{"id":"755927fb.abb3e8","type":"Hue Pull","z":"3d0770ee.9fd28","deviceid":"g-2","serverid":"001788fffe4db78d","name":"","x":600,"y":880,"wires":[["cd741398.4deb9"],[]]},{"id":"89bae89.719c318","type":"debug","z":"3d0770ee.9fd28","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":750,"y":960,"wires":[]},{"id":"1a319330.115c7d","type":"switch","z":"3d0770ee.9fd28","name":"Dim Button","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"3002","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":410,"y":860,"wires":[["755927fb.abb3e8"]]},{"id":"a8a25e27.d362","type":"mqtt in","z":"3d0770ee.9fd28","name":"","topic":"hue/kitchen_sensor/presence","qos":"2","broker":"e14ddd74.e008f","x":120,"y":260,"wires":[["32c81345.aec2ec"]]},{"id":"32c81345.aec2ec","type":"switch","z":"3d0770ee.9fd28","name":"Motion Detected?","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"true","vt":"str"},{"t":"eq","v":"false","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":278.91058349609375,"y":196.67098999023438,"wires":[["8cee1e78.e4952","20dded2b.05a4c2"],["58c92e93.94512"]]},{"id":"e6a2cbe3.466b78","type":"switch","z":"3d0770ee.9fd28","name":"Motion Detected?","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"true","vt":"str"},{"t":"eq","v":"false","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":450,"y":300,"wires":[["cb9b659b.08da48","319bdedb.908ae2"],["fbed19fb.f048e8"]]},{"id":"764b8536.761ffc","type":"function","z":"3d0770ee.9fd28","name":"Advanced Button Controller","func":"//button: \"3002\"\n//on: true\n//bri: 1\n//ct: 198\n//alert: \"none\"\n//colormode: \"ct\"\n\n\n\nfunction BrightnessDown(current_brightness) {\n    newBrightnessPct = (current_brightness / 256 - 0.25) * 100\n    return Math.max(0, Math.min(100, Math.round(newBrightnessPct)))\n}\n\nfunction BrightnessUp(current_brightness) {\n    newBrightnessPct = (current_brightness / 256 + 0.25) * 100\n    return Math.max(0, Math.min(100, Math.round(newBrightnessPct)))\n}\n\nfunction AdjustMessage(bri) {\n    newmsg = {\n        payload: {\n            \"data\": {\n                \"entity_id\": \"light.kitchen\",\n                \"brightness_pct\": bri\n            }    \n        }\n    }\n    return newmsg\n}\n\n//PARSE BUTTON PRESS\nvar bri = { payload:\"unknown entry \" + msg.payload.button}\nswitch(msg.payload.button) {\n  case \"3002\":\n    // Dim Short \n    // Dim by 25%\n\n    if(msg.payload.on===true) {\n        // reduce brightness 25%\n        var bri = BrightnessDown(msg.payload.bri)\n        return ([ null, AdjustMessage(bri), null, null, null ]);\n    } else {  \n        // turn on brightness 10%\n        return ([ null, AdjustMessage(5), null, null, null ]);\n    } break\n\n  case \"2002\":\n    // Brighten Short\n    var bri = BrightnessUp(msg.payload.bri)\n    return ([ null, AdjustMessage(bri) , null, null, null ]);\n\n  case \"1002\":\n    // On short\n    turnon = {payload: \"data\"}\n    return ([ turnon, null , null , null, null ]);\n\n  case \"1003\":\n    // Hold On 4 Seconds and release\n    turnonlamp = {payload: \"on\"}\n    return ([ null, null , null , turnonlamp, null ]);\n    \n  case \"4002\":\n    // Off\n    turnoff = {payload: \"data\"}\n    return ([ null, null , turnoff , null, null ]);\n    \n  case \"4003\":\n    // Hold Off 4 Seconds and release\n    turnofflamp = {payload: \"off\"}\n    return ([ null, null , null , turnofflamp, null ]);\n    \n  default:\n    // code block\n    POOP = {payload:msg.payload.button}\n    return ([ null,  null , null, null, POOP ]);\n}\n\n\n\n//this.send([ msg1 , msg2 ]);\n//return ([ NewMsg , POOP ]);","outputs":5,"noerr":0,"x":740,"y":1100,"wires":[["4ff27842.239688"],["2c0bf2b9.275fae"],["ab05f71f.d69fe8"],["7f7f21dd.2e598"],["89bae89.719c318"]],"outputLabels":["Kitchen Lights On","Adjust Kitchen Lights","Kitchen Lights Off","Switch On","Unknown - send to debug"]},{"id":"c0748a4b.4af668","type":"hue-bridge-node","z":"3d0770ee.9fd28","name":"","bridge":"2765943d.d5b22c","autoupdates":true,"x":570,"y":1240,"wires":[["53bb7cc7.88ba14"]]},{"id":"73f2c495.dd8c4c","type":"inject","z":"3d0770ee.9fd28","name":"Simulate Press Hue Button","topic":"","payload":"{\"pressButton\":true}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":280,"y":1220,"wires":[["c0748a4b.4af668"]]},{"id":"8fbe4268.72746","type":"Hue Pull","z":"3d0770ee.9fd28","deviceid":"g-2","serverid":"001788fffe4db78d","name":"","x":360,"y":1120,"wires":[["4f97afb7.cc76a"],[]]},{"id":"4f97afb7.cc76a","type":"join","z":"3d0770ee.9fd28","name":"","mode":"custom","build":"merged","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"2","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":530,"y":1100,"wires":[["764b8536.761ffc","89bae89.719c318"]]},{"id":"46e7329e.b1126c","type":"change","z":"3d0770ee.9fd28","name":"","rules":[{"t":"move","p":"payload","pt":"msg","to":"payload.button","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":370,"y":1060,"wires":[["4f97afb7.cc76a"]]},{"id":"ab05f71f.d69fe8","type":"api-call-service","z":"3d0770ee.9fd28","name":"Kitchen Lights Off","server":"18ecc450.cecb0c","service_domain":"light","service":"turn_off","data":"{ \"entity_id\": \"light.kitchen\" , \"transition\": \"0.5\"}","mergecontext":"","x":1070,"y":1100,"wires":[[]]},{"id":"4ff27842.239688","type":"api-call-service","z":"3d0770ee.9fd28","name":"Kitchen Lights On","server":"18ecc450.cecb0c","service_domain":"light","service":"turn_on","data":"{ \"entity_id\": \"light.kitchen\", \"brightness_pct\": \"100\" }","mergecontext":"","x":1090,"y":1000,"wires":[[]]},{"id":"6d99b08f.3a1bd","type":"api-current-state","z":"3d0770ee.9fd28","name":"Stop if in bed","server":"18ecc450.cecb0c","halt_if":"1","override_topic":false,"override_payload":false,"entity_id":"sensor.bed_occupied","x":970,"y":360,"wires":[["754fa58e.7860ec"]]},{"id":"1eeafc96.0660f3","type":"api-call-service","z":"3d0770ee.9fd28","name":"Bed Nightlight","server":"18ecc450.cecb0c","service_domain":"light","service":"turn_on","data":"{ \"entity_id\": \"light.under_bed_lightstrip\",  \"brightness\": \"50\", \"xy_color\": [\"0.683\", \"0.307\"]}","mergecontext":"","x":1850,"y":240,"wires":[[]]},{"id":"319bdedb.908ae2","type":"api-current-state","z":"3d0770ee.9fd28","name":"Bed Status","server":"18ecc450.cecb0c","halt_if":"","override_topic":true,"override_payload":true,"entity_id":"sensor.bed_occupied","x":723.26953125,"y":236.00390625,"wires":[["692006a4.ccafd8"]]},{"id":"692006a4.ccafd8","type":"switch","z":"3d0770ee.9fd28","name":"In Bed?","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":883.26953125,"y":237.00390625,"wires":[["8ea9e0e3.570f3"],["3cb9214f.ee15fe"]]},{"id":"8ea9e0e3.570f3","type":"time-range-switch","z":"3d0770ee.9fd28","name":"","lat":"","lon":"","startTime":"06:15","endTime":"20:00","startOffset":0,"endOffset":0,"x":1010,"y":160,"wires":[[],["74f94b8a.f8fd54"]]},{"id":"41b65be3.2d70a4","type":"api-current-state","z":"3d0770ee.9fd28","name":"Bed Status","server":"18ecc450.cecb0c","halt_if":"","override_topic":true,"override_payload":true,"entity_id":"sensor.bed_occupied","x":1350,"y":80,"wires":[[]]},{"id":"a0834b84.47a918","type":"switch","z":"3d0770ee.9fd28","name":"Is light on/bright","property":"payload.state.bri","propertyType":"msg","rules":[{"t":"lte","v":"25","vt":"str"},{"t":"gt","v":"25","vt":"str"},{"t":"empty"}],"checkall":"true","repair":false,"outputs":3,"x":1620,"y":180,"wires":[["1eeafc96.0660f3"],[],[]]},{"id":"fbb2ef29.17677","type":"switch","z":"3d0770ee.9fd28","name":"is light on?","property":"payload.state.on","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":1410,"y":240,"wires":[["a0834b84.47a918"],["1eeafc96.0660f3"]]},{"id":"19e62723.fd78f9","type":"inject","z":"3d0770ee.9fd28","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1040,"y":320,"wires":[["754fa58e.7860ec"]]},{"id":"7f7f21dd.2e598","type":"switch","z":"3d0770ee.9fd28","name":"On or Off","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1260,"y":600,"wires":[["58c9c6db.cdf258"],["3d32bc95.2b1c04"]]},{"id":"53bb7cc7.88ba14","type":"debug","z":"3d0770ee.9fd28","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":750,"y":1240,"wires":[]},{"id":"a2152138.f1137","type":"start-up-trigger","z":"3d0770ee.9fd28","x":200,"y":1320,"wires":[["ddb4a918.9e7b88"]]},{"id":"e1a518eb.200d28","type":"mqtt in","z":"3d0770ee.9fd28","name":"","topic":"hue/bedroom_sensor/presence","qos":"2","broker":"e14ddd74.e008f","x":122.71428680419922,"y":307,"wires":[["e6a2cbe3.466b78"]]},{"id":"5baf4a35.067a34","type":"server-state-changed","z":"3d0770ee.9fd28","name":"BedPresenceMath","server":"18ecc450.cecb0c","entityidfilter":"sensor.num_in_master_bed","entityidfiltertype":"substring","haltifstate":"","x":130,"y":420,"wires":[["20d8ceaa.114d72"]]},{"id":"20d8ceaa.114d72","type":"trigger-state","z":"3d0770ee.9fd28","name":"Bed Initial Occupation","server":"18ecc450.cecb0c","entityid":"sensor.num_in_master_bed","debugenabled":false,"constraints":[{"id":"39inxqy7dyc","targetType":"this_entity","targetValue":"","propertyType":"previous_state","propertyValue":"old_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"0"},{"id":"a616sedkoc","targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"greater_than","comparatorValueDatatype":"str","comparatorValue":"0"}],"constraintsmustmatch":"all","outputs":2,"customoutputs":[],"x":360,"y":420,"wires":[["68ee029e.cccf2c"],[]]},{"id":"68ee029e.cccf2c","type":"time-range-switch","z":"3d0770ee.9fd28","name":"Near Bedtime","lat":"","lon":"","startTime":"20:45","endTime":"23:15","startOffset":0,"endOffset":0,"x":560,"y":420,"wires":[["fbed19fb.f048e8","c4754556.a9e928","19f56dd3.eed152"],[]]},{"id":"74f94b8a.f8fd54","type":"api-current-state","z":"3d0770ee.9fd28","name":"Underglow Status","server":"18ecc450.cecb0c","halt_if":"","override_topic":true,"override_payload":true,"entity_id":"light.under_bed_lightstrip","x":1230,"y":180,"wires":[["fbb2ef29.17677"]]},{"id":"ddb4a918.9e7b88","type":"change","z":"3d0770ee.9fd28","name":"Press Hue Button","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"pressButton\":true}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":410,"y":1300,"wires":[["c0748a4b.4af668"]]},{"id":"c4754556.a9e928","type":"api-call-service","z":"3d0770ee.9fd28","name":"Bed Bedtime Lights","server":"18ecc450.cecb0c","service_domain":"light","service":"turn_on","data":"{ \"entity_id\": \"light.bedroom\",  \"transition\":\"15\", \"brightness\": \"50\", \"kelvin\": \"4000\"}","mergecontext":"","x":820,"y":420,"wires":[["658ac4c7.e9dccc"]]},{"id":"d3cca85.a064858","type":"inject","z":"3d0770ee.9fd28","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":620,"y":460,"wires":[["c4754556.a9e928","19f56dd3.eed152"]]},{"id":"658ac4c7.e9dccc","type":"stoptimer","z":"3d0770ee.9fd28","duration":"5","units":"Minute","payloadtype":"num","payloadval":"0","name":"","x":1040,"y":440,"wires":[["8e89d93d.8aae48"],[]]},{"id":"8e89d93d.8aae48","type":"api-call-service","z":"3d0770ee.9fd28","name":"Bedroom Slow Off","server":"18ecc450.cecb0c","service_domain":"light","service":"turn_off","data":"{ \"entity_id\": \"light.bedroom\", \"transition\": \"60\" }","mergecontext":"","x":1250,"y":420,"wires":[[]]},{"id":"19f56dd3.eed152","type":"api-call-service","z":"3d0770ee.9fd28","name":"Sound Machine On","server":"18ecc450.cecb0c","service_domain":"switch","service":"turn_on","data":"{ \"entity_id\": \"switch.sound_machine\" }","mergecontext":"","x":820,"y":460,"wires":[[]]}]